@model IEnumerable<PharmacyChain.Models.Sale>

@{
    ViewData["Title"] = "Результат тесту (велика вибірка)";
}

<div class="container mt-4">
    <h2><i class="bi bi-check-circle"></i> Результат тесту (велика вибірка)</h2>

    <div class="alert alert-success">
        <h5><i class="bi bi-speedometer2"></i> Метод: @ViewBag.Method</h5>
        <hr />
        <div class="row">
            <div class="col-md-2">
                <strong>Записів:</strong><br />
                <h3>@ViewBag.RecordCount.ToString("N0")</h3>
            </div>
            <div class="col-md-2">
                <strong>Час (мс):</strong><br />
                <h3 class="text-primary">@ViewBag.ElapsedMs мс</h3>
            </div>
            <div class="col-md-2">
                <strong>Час (сек):</strong><br />
                <h3 class="text-info">@ViewBag.ElapsedSeconds.ToString("F2") с</h3>
            </div>
            <div class="col-md-3">
                <strong>Швидкість:</strong><br />
                <h3>@((ViewBag.RecordCount / ViewBag.ElapsedSeconds).ToString("F0")) рек/с</h3>
            </div>
            <div class="col-md-3">
                <strong>Тіки:</strong><br />
                <h3>@ViewBag.ElapsedTicks.ToString("N0")</h3>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <h6><i class="bi bi-info-circle"></i> Статистика:</h6>
        <ul class="mb-0">
            <li>Час на 1 запис: <strong>@((ViewBag.ElapsedMs / (double)ViewBag.RecordCount).ToString("F4")) мс</strong></li>
            <li>Процесорів використано: <strong>@Environment.ProcessorCount</strong></li>
        </ul>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Зразок даних (перші 20 записів)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Аптека</th>
                            <th>Клієнт</th>
                            <th>Дата</th>
                            <th>Позиції</th>
                            <th>Сума</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var sale in Model.Take(20))
                        {
                            <tr>
                                <td>@sale.Id</td>
                                <td><small>@(sale.Pharmacy?.Name ?? "N/A")</small></td>
                                <td><small>@(sale.Customer?.FullName ?? "Анонім")</small></td>
                                <td><small>@sale.CreatedAt.ToString("dd.MM.yy HH:mm")</small></td>
                                <td>@sale.Lines.Count</td>
                                <td><strong>@sale.Total.ToString("F2")</strong></td>
                                <td>
                                    <span class="badge bg-success">@sale.PaymentStatus</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.Count() > 20)
            {
                <p class="text-muted text-center mt-3">
                    ... та ще @((Model.Count() - 20).ToString("N0")) записів
                </p>
            }
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Назад до тестів
        </a>
        <button class="btn btn-success" onclick="window.location.href = window.location.href">
            <i class="bi bi-arrow-clockwise"></i> Повторити тест
        </button>
    </div>
</div>

@section Scripts {
    <script>
        // Автоматично зберегти результат
        const result = {
            method: '@ViewBag.Method',
            recordCount: @ViewBag.RecordCount,
            elapsedMs: @ViewBag.ElapsedMs,
            elapsedSeconds: @ViewBag.ElapsedSeconds,
            timestamp: new Date().toISOString()
        };

        let testResults = JSON.parse(localStorage.getItem('testResults') || '[]');
        testResults.push(result);

        // Зберігаємо останні 50 результатів
        if (testResults.length > 50) {
            testResults = testResults.slice(-50);
        }

        localStorage.setItem('testResults', JSON.stringify(testResults));

        console.log('? Результат збережено:', result);

        // Показати повідомлення
        setTimeout(() => {
            const speedup = calculateSpeedup(result);
            alert('? Результат додано до таблиці порівняння!\n\n' +
                  'Метод: ' + result.method + '\n' +
                  'Час: ' + result.elapsedMs + ' мс (' + result.elapsedSeconds + ' сек)\n' +
                  'Записів: ' + result.recordCount.toLocaleString() + '\n' +
                  (speedup ? 'Прискорення: ' + speedup : ''));
        }, 500);

        function calculateSpeedup(currentResult) {
            const baseline = testResults.find(r => 
                r.method.includes('Послідовний') && 
                r.recordCount === currentResult.recordCount
            );
            
            if (baseline && currentResult.method !== baseline.method) {
                return (baseline.elapsedMs / currentResult.elapsedMs).toFixed(2) + 'x';
            }
            return null;
        }
    </script>
}
